;----------------------------------------------------------------------------
; startup.asm - NES 6502用スタートアップコード
; 2025 By Kanno-Develop
;
; 本ファイルはNESの初期化処理と割り込みベクタ設定を行います。
; C言語で書かれたメイン処理（NesMain）へ制御を渡します。
;----------------------------------------------------------------------------
; 6502 CPU向けのアセンブリコード設定
.setcpu		"6502"
; 自動インポート機能をONにする
.autoimport	on
; ゼロページ変数 "sp" をインポート（スタックポインタ用のラベルとして使用）
.IMPORTZP	sp
; C言語の関数NesMainをグローバル公開（リンク時に参照可能にする）
.global	_NesMain

; ------------------------------------------------------------
; NES ROMヘッダーセグメント
; "NES"識別子とROMのバンク数、マッパー設定などを記述
; ------------------------------------------------------------
.segment "HEADER"
    .byte	$4E, $45, $53, $1A	; "NES" ヘッダー固定文字列
    .byte	$02			; PRG-ROMバンク数 (16KB単位) - 2バンク = 32KB
    .byte	$01			; CHR-ROMバンク数 (8KB単位) - 1バンク = 8KB
    .byte	$00			; マッパーフラグ (0:水平ミラー, 1:垂直ミラー, 2=両方, 3=両方+WRAMミラー)
    .byte	$00			; 
    .byte	$00, $00, $00, $00	;
    .byte	$00, $00, $00, $00	;


; ------------------------------------------------------------
; リセット処理（エントリポイント）
; CPU初期化、スタックポインタ設定、メイン処理呼び出し
; ------------------------------------------------------------
.segment "STARTUP"
.proc	Reset
    sei
    ldx	#$ff
    txs

    lda	#$ff
    sta	sp
    lda	#$03
    sta	sp + 1

    jsr	_NesMain         ; CのNesMain()関数を呼び出し、メイン処理開始
    
.endproc


; ------------------------------------------------------------
; NMI割り込みベクタ
; VBlank時に呼ばれる割り込み処理へジャンプ
; ------------------------------------------------------------
.proc	NMI
    jsr _NMIProc         ; CのNMIProc()割り込み処理関数を呼ぶ
    rti                  ; 割り込みから復帰
.endproc


; ------------------------------------------------------------
; 割り込みベクタテーブル
; NMI, リセットを設定
; ------------------------------------------------------------
.segment "VECINFO"
    .word	NMI
    .word	Reset
    .word	$0000

; ------------------------------------------------------------
; CHR-ROMデータ
; ここにBGやスプライトのタイルデータを読み込む
; ------------------------------------------------------------
.segment "CHARS"
    .incbin "bg.chr"      ; 背景用CHRデータ
    .incbin	"sprite.chr"  ; スプライト用CHRデータ